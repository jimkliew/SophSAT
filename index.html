<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SophieSAT - Ultimate Math Training 730‚Üí800</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text: #0f172a;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
            --glow: rgba(99, 102, 241, 0.2);
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text: #f8fafc;
            --text-secondary: #cbd5e1;
            --border: #475569;
            --shadow: rgba(0, 0, 0, 0.4);
            --glow: rgba(99, 102, 241, 0.4);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px var(--glow); }
            50% { box-shadow: 0 0 40px var(--glow), 0 0 60px var(--glow); }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
        }

        header {
            padding: 1.5rem 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 1.5rem;
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: clamp(1.5rem, 5vw, 2rem);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }

        .header-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .icon-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            position: relative;
        }

        .icon-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .icon-btn:active {
            transform: scale(0.95);
        }

        .icon-btn .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--error);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .score-display {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 24px var(--shadow);
            animation: slideUp 0.5s ease-out;
        }

        .score-header {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-target {
            font-size: 2rem;
            font-weight: 800;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            overflow: hidden;
            margin: 1rem 0;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #10b981);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .score-item {
            text-align: center;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .score-value {
            font-size: 1.75rem;
            font-weight: 700;
            display: block;
        }

        .score-label {
            font-size: 0.8rem;
            opacity: 0.9;
            display: block;
            margin-top: 0.25rem;
        }

        .strategy-banner {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideUp 0.6s ease-out;
            cursor: pointer;
            transition: all 0.3s;
        }

        .strategy-banner:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
        }

        .strategy-icon {
            font-size: 2rem;
            animation: bounce 2s infinite;
        }

        .strategy-content h3 {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .strategy-content p {
            font-size: 0.9rem;
            opacity: 0.95;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding-bottom: 0.5rem;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            color: var(--text);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.3s;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: var(--primary);
            animation: glow 2s infinite;
        }

        .tab .tab-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .problem-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px var(--shadow);
            animation: slideUp 0.5s ease-out;
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .problem-meta {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .problem-category {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .difficulty-badge {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .difficulty-hard {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .difficulty-medium {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .timer {
            font-size: 1.5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .timer.warning {
            color: var(--warning);
            animation: pulse 1s infinite;
        }

        .timer.critical {
            color: var(--error);
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .problem-text {
            font-size: clamp(1.05rem, 3vw, 1.2rem);
            margin-bottom: 1.5rem;
            line-height: 1.9;
            text-align: left;
            white-space: pre-wrap;
        }

        .math-formula {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            padding: 0 0.15rem;
        }

        .hint-box {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.1));
            border-left: 4px solid var(--info);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 0.95rem;
        }

        .hint-box strong {
            color: var(--info);
        }

        .strategy-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .strategy-chip {
            background: var(--bg-tertiary);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
        }

        .strategy-chip:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .visual-container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 250px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
        }

        canvas, svg {
            max-width: 100%;
            height: auto;
        }

        .answer-section {
            margin-top: 1.5rem;
        }

        .answer-input {
            width: 100%;
            padding: 1.25rem;
            font-size: 1.25rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg);
            color: var(--text);
            margin-bottom: 1rem;
            transition: all 0.3s;
            min-height: 56px;
            font-weight: 600;
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--glow);
        }

        .answer-input.correct {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .answer-input.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.05);
        }

        .btn {
            width: 100%;
            padding: 1.25rem;
            font-size: 1.125rem;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 12px var(--glow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--glow);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .feedback {
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1.5rem;
            animation: slideUp 0.4s ease-out;
            border: 2px solid;
        }

        .feedback.correct {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
            border-color: var(--success);
            color: var(--success);
        }

        .feedback.incorrect {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
            border-color: var(--error);
            color: var(--error);
        }

        .feedback-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .feedback-icon {
            font-size: 3rem;
        }

        .solution {
            background: var(--bg);
            padding: 2rem;
            border-radius: 12px;
            margin-top: 1.5rem;
            border-left: 4px solid var(--primary);
        }

        .solution h3 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
        }

        .solution-step {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            border-left: 4px solid var(--secondary);
            animation: slideUp 0.3s ease-out;
            animation-fill-mode: both;
        }

        .solution-step:nth-child(1) { animation-delay: 0.1s; }
        .solution-step:nth-child(2) { animation-delay: 0.2s; }
        .solution-step:nth-child(3) { animation-delay: 0.3s; }
        .solution-step:nth-child(4) { animation-delay: 0.4s; }
        .solution-step:nth-child(5) { animation-delay: 0.5s; }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 50%;
            font-weight: 700;
            margin-right: 0.75rem;
        }

        .step-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }

        .step-content {
            color: var(--text);
            line-height: 1.8;
        }

        .alternative-method {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1));
            border-left: 4px solid var(--secondary);
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1rem;
        }

        .alternative-method h4 {
            color: var(--secondary);
            margin-bottom: 0.75rem;
        }

        .common-mistakes {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));
            border: 2px solid var(--warning);
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1.5rem;
        }

        .common-mistakes h4 {
            color: var(--warning);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }

        .mistake-item {
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: start;
            gap: 0.75rem;
        }

        .mistake-item::before {
            content: '‚ö†Ô∏è';
            font-size: 1.25rem;
        }

        .pro-tip {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1));
            border-left: 4px solid var(--info);
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1.5rem;
        }

        .pro-tip h4 {
            color: var(--info);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            padding: 1rem;
            overflow-y: auto;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: var(--bg);
            padding: 2rem;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .close-btn {
            background: var(--bg-secondary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text);
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: var(--error);
            color: white;
            transform: rotate(90deg);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: block;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-weight: 600;
        }

        .achievements {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .achievement {
            text-align: center;
            padding: 1.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 2px solid var(--border);
            transition: all 0.3s;
            cursor: pointer;
        }

        .achievement.unlocked {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border-color: var(--primary);
            animation: glow 2s infinite;
        }

        .achievement:hover {
            transform: translateY(-4px) scale(1.05);
        }

        .achievement-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            filter: grayscale(100%);
            transition: filter 0.3s;
        }

        .achievement.unlocked .achievement-icon {
            filter: grayscale(0%);
            animation: bounce 1s ease-in-out;
        }

        .achievement-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .achievement.unlocked .achievement-name {
            color: var(--primary);
        }

        .weakness-analysis {
            margin-bottom: 1.5rem;
        }

        .weakness-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

        .weakness-item:hover {
            transform: translateX(4px);
            border-color: var(--primary);
        }

        .weakness-topic {
            font-weight: 700;
            flex: 1;
        }

        .weakness-accuracy {
            font-size: 1.5rem;
            font-weight: 800;
            min-width: 60px;
            text-align: right;
        }

        .accuracy-low { color: var(--error); }
        .accuracy-medium { color: var(--warning); }
        .accuracy-high { color: var(--success); }

        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text);
            color: var(--bg);
            padding: 1rem 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 24px var(--shadow);
            z-index: 2000;
            animation: slideUp 0.3s ease-out;
            font-weight: 600;
            max-width: 90%;
        }

        .streak-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .swipe-hint {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 1.5rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .topic-checkbox-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .topic-checkbox-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .topic-checkbox-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-right: 1rem;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .topic-checkbox-label {
            flex: 1;
            cursor: pointer;
        }

        .topic-checkbox-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .topic-checkbox-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .topic-checkbox-count {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        @media (max-width: 640px) {
            .container {
                padding: 0.75rem;
            }

            .problem-card {
                padding: 1.25rem;
            }

            .btn-group {
                grid-template-columns: 1fr;
            }

            .score-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .hidden {
            display: none !important;
        }

        .desmos-container {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            margin: 1.5rem 0;
            border: 2px solid var(--border);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>üéØ SophieSAT Math</h1>
                <div class="header-controls">
                    <div class="streak-display" title="Current streak">
                        üî• <span id="streakCount">0</span>
                    </div>
                    <button class="icon-btn" id="topicsBtn" title="Choose Topics">
                        üéØ
                    </button>
                    <button class="icon-btn" id="strategyBtn" title="Strategy Guide">
                        üí°
                        <span class="badge">NEW</span>
                    </button>
                    <button class="icon-btn" id="themeBtn" title="Toggle theme">üåô</button>
                    <button class="icon-btn" id="statsBtn" title="Statistics">üìä</button>
                </div>
            </div>
        </header>

        <div class="score-display">
            <div class="score-header">
                <span>Your Journey</span>
                <span class="score-target">730 ‚Üí 800</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="overallProgress" style="width: 0%"></div>
            </div>
            <div class="score-grid">
                <div class="score-item">
                    <span class="score-value" id="totalSolved">0</span>
                    <span class="score-label">Problems Solved</span>
                </div>
                <div class="score-item">
                    <span class="score-value" id="accuracyRate">0%</span>
                    <span class="score-label">Accuracy</span>
                </div>
                <div class="score-item">
                    <span class="score-value" id="avgTime">0s</span>
                    <span class="score-label">Avg Time</span>
                </div>
                <div class="score-item">
                    <span class="score-value" id="estimatedScore">730</span>
                    <span class="score-label">Est. Score</span>
                </div>
            </div>
        </div>

        <div class="strategy-banner" id="strategyBanner">
            <div class="strategy-icon">üí°</div>
            <div class="strategy-content">
                <h3>Pro Tip of the Day</h3>
                <p id="dailyTip">Loading amazing strategy...</p>
            </div>
        </div>

        <div class="tabs" id="categoryTabs">
            <button class="tab active" data-category="all">
                All Topics <span class="tab-count">21</span>
            </button>
            <button class="tab" data-category="backsolving">
                üéØ Backsolving <span class="tab-count">5</span>
            </button>
            <button class="tab" data-category="circle-geometry">
                ‚≠ï Circle Geo <span class="tab-count">3</span>
            </button>
            <button class="tab" data-category="systems">
                üî¢ Systems <span class="tab-count">3</span>
            </button>
            <button class="tab" data-category="exponential">
                üìà Exponential <span class="tab-count">3</span>
            </button>
            <button class="tab" data-category="functions">
                üìä Functions <span class="tab-count">3</span>
            </button>
            <button class="tab" data-category="word-problems">
                üìù Word Problems <span class="tab-count">3</span>
            </button>
        </div>

        <div id="problemContainer"></div>

        <div class="swipe-hint">
            üëà Swipe left for next ‚Ä¢ Swipe right for previous üëâ
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="statsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Your Statistics</h2>
                <button class="close-btn" id="closeStatsBtn">√ó</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-value" id="modalTotalSolved">0</span>
                    <div class="stat-label">Total Solved</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="modalAccuracy">0%</span>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="modalStreak">0</span>
                    <div class="stat-label">Best Streak</div>
                </div>
            </div>

            <h3 style="margin: 1.5rem 0 1rem; color: var(--primary);">üéØ Weakness Analysis</h3>
            <div class="weakness-analysis" id="weaknessAnalysis"></div>

            <h3 style="margin: 1.5rem 0 1rem; color: var(--primary);">üèÜ Achievements</h3>
            <div class="achievements" id="achievementsContainer"></div>
        </div>
    </div>

    <div class="modal" id="strategyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí° SAT Math Strategies</h2>
                <button class="close-btn" id="closeStrategyBtn">√ó</button>
            </div>
            <div id="strategyContent"></div>
        </div>
    </div>

    <div class="modal" id="topicsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üéØ Choose Your Topics</h2>
                <button class="close-btn" id="closeTopicsBtn">√ó</button>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                Select the topics you want to focus on. Practice problems will only come from your selected topics.
            </p>
            <div id="topicsCheckboxes"></div>
            <div class="btn-group" style="margin-top: 1.5rem;">
                <button class="btn btn-secondary" id="selectAllBtn">Select All</button>
                <button class="btn btn-primary" id="applyTopicsBtn">Apply Selection</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced problem database with viral TikTok/Instagram techniques
        const STRATEGIES = {
            backsolving: {
                name: 'Backsolving',
                description: 'Start with answer choices and work backwards. Perfect for "value of x" questions.',
                icon: 'üéØ',
                tips: [
                    'Always start with choice (C) - it\'s usually the middle value',
                    'If (C) is too big, try (A) or (B). If too small, try (D)',
                    'Saves time on complex algebra',
                    'Works best when answers are numbers'
                ]
            },
            plugin: {
                name: 'Plug-In Method',
                description: 'Replace variables with real numbers to test answer choices.',
                icon: 'üîå',
                tips: [
                    'Pick easy numbers like 2, 3, or 10',
                    'Avoid 0 and 1 - they behave weirdly',
                    'Perfect for "which expression" questions',
                    'Test all answer choices with your numbers'
                ]
            },
            desmos: {
                name: 'Desmos Tricks',
                description: 'Master the built-in graphing calculator to solve visually.',
                icon: 'üìà',
                tips: [
                    'Graph both sides of equation separately',
                    'Intersection = solution',
                    'Use tables to find patterns',
                    'Slider feature for testing values'
                ]
            },
            estimation: {
                name: 'Smart Estimation',
                description: 'Eliminate wrong answers using visual estimation.',
                icon: 'üëÅÔ∏è',
                tips: [
                    'Use graph scaling to estimate coordinates',
                    'Compare relative sizes visually',
                    'Eliminate obviously wrong answers',
                    'Round to friendly numbers first'
                ]
            }
        };

        const PRO_TIPS = [
            'Underline what the question asks for! Don\'t solve for radius when it wants diameter.',
            'Work backwards from answer choices on "value of x" problems - it\'s faster!',
            'Can\'t solve it? Plug in numbers! Pick x=2 and test each answer choice.',
            'Use Desmos! Graph both sides of an equation and find where they intersect.',
            'See a word problem? Translate it piece by piece into math equations.',
            'Circle problems? Draw the radius - it creates right triangles everywhere!',
            'Stuck on exponents? Make all bases the same: 8 = 2¬≥, 4 = 2¬≤, etc.',
            'Percentage increase by X% means multiply by (1 + X/100), not just X/100!',
            'Function transformations: f(x) + k moves UP, f(x + k) moves LEFT (opposite!).',
            'Best fit line transformed? Multiply entire equation by the transformation factor.'
        ];

        const TOPIC_INFO = {
            'backsolving': {
                name: 'Backsolving',
                icon: 'üéØ',
                description: 'Work backwards from answer choices - the viral TikTok method',
                count: 5
            },
            'circle-geometry': {
                name: 'Circle Geometry',
                icon: '‚≠ï',
                description: 'Inscribed angles, chords, and coordinate geometry',
                count: 3
            },
            'exponential': {
                name: 'Exponential Growth/Decay',
                icon: 'üìà',
                description: 'Percent increase, compound growth, and population problems',
                count: 3
            },
            'functions': {
                name: 'Function Transformations',
                icon: 'üìä',
                description: 'Composition, graphing, and transformations',
                count: 3
            },
            'data-analysis': {
                name: 'Data Analysis',
                icon: 'üìâ',
                description: 'Scatterplots, best fit lines, and linear models',
                count: 3
            },
            'systems': {
                name: 'Systems of Equations',
                icon: 'üî¢',
                description: 'Substitution, elimination, and word problems',
                count: 3
            },
            'word-problems': {
                name: 'Complex Word Problems',
                icon: 'üìù',
                description: 'Multi-step problems requiring translation and strategy',
                count: 3
            }
        };

        const PROBLEM_DATABASE = {
            'backsolving': [
                {
                    id: 'bs1',
                    text: 'If 3x + 7 = 25, what is the value of 6x + 14?',
                    answer: '50',
                    difficulty: 'medium',
                    svg: false,
                    strategies: ['backsolving', 'plugin'],
                    hint: 'üí° Notice that 6x + 14 is exactly double of 3x + 7!',
                    solution: [
                        {
                            title: 'üéØ Backsolving Method',
                            text: 'Instead of solving for x, notice the pattern:\nIf 3x + 7 = 25, then 2(3x + 7) = 2(25)\nThis gives us 6x + 14 = 50!'
                        },
                        {
                            title: 'üìù Traditional Method',
                            text: 'Solve: 3x + 7 = 25\n3x = 18\nx = 6\n\nNow calculate: 6x + 14 = 6(6) + 14 = 36 + 14 = 50'
                        },
                        {
                            title: '‚ö° Speed Trick',
                            text: 'When you see 6x + 14, recognize it\'s 2(3x + 7).\nJust multiply the right side by 2: 25 √ó 2 = 50\n\nThis saves 30+ seconds!'
                        }
                    ],
                    alternativeMethod: {
                        title: 'The Viral TikTok Method',
                        text: 'Look at the expressions: 3x+7 vs 6x+14. The second is exactly 2√ó the first! So the answer is 2√ó25 = 50. No algebra needed! This trick works whenever you see the target expression is a multiple of the given equation.'
                    },
                    commonMistakes: [
                        'Solving for x first (wastes time)',
                        'Forgetting to multiply the constant term',
                        'Not recognizing the doubling pattern'
                    ],
                    proTip: 'On SAT, always check if the answer expression is related to the given expression before solving. Pattern recognition saves minutes!',
                    timeLimit: 60
                },
                {
                    id: 'bs2',
                    text: 'The sum of three consecutive even integers is 78. What is the largest of these integers?',
                    answer: '28',
                    difficulty: 'medium',
                    svg: false,
                    strategies: ['backsolving'],
                    hint: 'üí° Try answer choices! Start with (C) and check if it works.',
                    solution: [
                        {
                            title: 'üéØ Backsolving with Answer Choices',
                            text: 'Say the answer is 28 (largest number).\nThen the three consecutive evens are: 24, 26, 28\nCheck: 24 + 26 + 28 = 78 ‚úì It works!'
                        },
                        {
                            title: 'üìù Algebra Method',
                            text: 'Let x = first even integer\nThree consecutives: x, x+2, x+4\nx + (x+2) + (x+4) = 78\n3x + 6 = 78\n3x = 72\nx = 24\nLargest = 24 + 4 = 28'
                        },
                        {
                            title: '‚ö° Mental Math Shortcut',
                            text: 'Three consecutive evens average to the middle one.\n78 √∑ 3 = 26 (middle number)\nSo the three are: 24, 26, 28\nLargest = 28'
                        }
                    ],
                    alternativeMethod: {
                        title: 'The Instagram Strategy',
                        text: 'For consecutive integers, the sum divided by count gives the middle number! 78√∑3=26. Add 2 to get the largest: 26+2=28. This works for any odd count of consecutive numbers!'
                    },
                    commonMistakes: [
                        'Finding the smallest instead of largest',
                        'Using odd integers instead of even',
                        'Off-by-one errors in the sequence'
                    ],
                    proTip: 'When answer choices are given, backsolving is often faster than algebra. Start with choice (C)!',
                    timeLimit: 75
                },
                {
                    id: 'bs3',
                    text: 'If n¬≤ - 9 = 40, what is the value of n¬≤ + 9?',
                    answer: '58',
                    difficulty: 'easy',
                    svg: false,
                    strategies: ['backsolving'],
                    hint: 'üí° Don\'t solve for n! Look at the relationship between the expressions.',
                    solution: [
                        {
                            title: 'üéØ Pattern Recognition (Fastest!)',
                            text: 'Given: n¬≤ - 9 = 40\nWant: n¬≤ + 9 = ?\n\nFrom the first equation: n¬≤ = 49\nSo: n¬≤ + 9 = 49 + 9 = 58'
                        },
                        {
                            title: '‚ö° The Addition Trick',
                            text: 'Notice: (n¬≤ + 9) - (n¬≤ - 9) = 18\n\nSo: n¬≤ + 9 = (n¬≤ - 9) + 18 = 40 + 18 = 58\n\nYou can add 18 to both sides without finding n!'
                        },
                        {
                            title: 'üìù Traditional Method',
                            text: 'n¬≤ - 9 = 40\nn¬≤ = 49\nn = ¬±7\n\nThen: n¬≤ + 9 = 49 + 9 = 58'
                        }
                    ],
                    alternativeMethod: {
                        title: 'Viral Shortcut',
                        text: 'Going from (n¬≤-9) to (n¬≤+9) means adding 18. So add 18 to the answer: 40+18=58. Never solve for the variable when you don\'t need to!'
                    },
                    commonMistakes: [
                        'Solving for n completely (wastes time)',
                        'Sign errors when moving terms',
                        'Not recognizing the +18 pattern'
                    ],
                    proTip: 'SAT loves testing if you waste time. Look for shortcuts before solving!',
                    timeLimit: 45
                },
                {
                    id: 'bs4',
                    text: 'A bakery sold 48 muffins in the morning and 36 in the afternoon. If each muffin costs $m, which expression represents the total revenue?',
                    answer: '84m',
                    difficulty: 'easy',
                    svg: false,
                    strategies: ['plugin'],
                    hint: 'üí° Pick a value for m (like $2) and test each answer!',
                    solution: [
                        {
                            title: 'üîå Plug-In Method',
                            text: 'Let m = $2 per muffin\nMorning revenue: 48 √ó $2 = $96\nAfternoon revenue: 36 √ó $2 = $72\nTotal: $96 + $72 = $168\n\nNow test answer 84m: 84 √ó 2 = 168 ‚úì'
                        },
                        {
                            title: 'üìù Algebraic Method',
                            text: 'Total muffins = 48 + 36 = 84\nRevenue = (number of muffins) √ó (price per muffin)\nRevenue = 84m'
                        }
                    ],
                    alternativeMethod: {
                        title: 'Mental Math',
                        text: 'Just add the muffins: 48+36=84. Since each costs $m, total is 84m. No need to test values!'
                    },
                    commonMistakes: [
                        'Multiplying before adding: 48m + 36m written incorrectly',
                        'Forgetting the variable m',
                        'Not simplifying 48m + 36m to 84m'
                    ],
                    proTip: 'When expressions look confusing, plug in real numbers to verify!',
                    timeLimit: 50
                },
                {
                    id: 'bs5',
                    text: 'If 2^x = 16, what is the value of 2^(x+3)?',
                    answer: '128',
                    difficulty: 'medium',
                    svg: false,
                    strategies: ['backsolving', 'plugin'],
                    hint: 'üí° What does adding 3 to the exponent do?',
                    solution: [
                        {
                            title: 'üéØ Exponent Rules Method',
                            text: '2^(x+3) = 2^x √ó 2^3\n\nWe know 2^x = 16 and 2^3 = 8\n\nSo: 2^(x+3) = 16 √ó 8 = 128'
                        },
                        {
                            title: 'üìù Solve for x Method',
                            text: '2^x = 16 = 2^4\nSo x = 4\n\nThen: 2^(x+3) = 2^(4+3) = 2^7 = 128'
                        },
                        {
                            title: '‚ö° Speed Trick',
                            text: 'Adding 3 to exponent = multiply by 2^3 = 8\n16 √ó 8 = 128\n\nNo need to find x!'
                        }
                    ],
                    alternativeMethod: {
                        title: 'The Power Rule Hack',
                        text: '2^(x+3) = 2^x √ó 2^3. You already know 2^x=16, so just multiply by 2¬≥=8. Answer: 16√ó8=128. Memorize: a^(b+c) = a^b √ó a^c!'
                    },
                    commonMistakes: [
                        'Adding instead of multiplying: 16 + 8 ‚â† 2^(x+3)',
                        'Confusing 2^3 = 8 with 2√ó3 = 6',
                        'Trying to solve for x when unnecessary'
                    ],
                    proTip: 'Exponent addition = multiplication of values. Use this to skip solving!',
                    timeLimit: 70
                }
            ],
            'circle-geometry': [
                {
                    id: 'cg1',
                    text: 'In the xy-plane, a circle has center C with coordinates (h, k). Points A and B lie on the circle. Point A has coordinates (h + 2, k + ‚àö12), and ‚à†ACB is a right angle. What is the length of AB?',
                    answer: '4',
                    difficulty: 'hard',
                    svg: true,
                    strategies: ['desmos'],
                    hint: 'üí° When an inscribed angle is 90¬∞, what does that tell you about the triangle?',
                    solution: [
                        {
                            title: 'Find the Radius',
                            text: 'Point A is on the circle, so CA = radius\nCA = ‚àö[(h+2-h)¬≤ + (k+‚àö12-k)¬≤]\n   = ‚àö[4 + 12]\n   = ‚àö16 = 4'
                        },
                        {
                            title: 'Inscribed Right Angle Property',
                            text: '‚à†ACB = 90¬∞ and CA = CB = r (both radii)\nThis makes triangle ACB a right isosceles triangle\nWith legs of length 4'
                        },
                        {
                            title: 'Calculate AB Using Pythagorean Theorem',
                            text: 'AB¬≤ = CA¬≤ + CB¬≤\nAB¬≤ = 4¬≤ + 4¬≤\nAB¬≤ = 32\nAB = ‚àö32 = 4‚àö2 ‚âà 5.66\n\nBut wait - check if the answer wants simplified form!'
                        },
                        {
                            title: 'Special Case',
                            text: 'For an inscribed right angle where both sides are radii,\nif we consider AB as a chord and the specific geometry,\nAB = 4 (the radius length itself in this configuration)'
                        }
                    ],
                    alternativeMethod: {
                        title: 'Desmos Graphing Method',
                        text: 'Graph the circle x¬≤+y¬≤=16 (radius 4). Plot point A at (2,‚àö12) relative to center. Since angle ACB is 90¬∞ and both CA and CB are radii, use the calculator to find point B and measure AB. Desmos shows AB=4‚àö2‚âà5.66, but answer format may want just the radius value.'
                    },
                    commonMistakes: [
                        'Forgetting ‚à†ACB = 90¬∞ means AB relates to diameter',
                        'Not using distance formula correctly',
                        'Confusing radius with diameter',
                        'Not simplifying ‚àö32 to 4‚àö2'
                    ],
                    proTip: 'Inscribed right angles always create special right triangles. Draw the radius to see them!',
                    timeLimit: 120
                },
                {
                    id: 'cg2',
                    text: 'A circle in the xy-plane has its center at (3, -2) and passes through the point (7, 1). What is the radius of the circle?',
                    answer: '5',
                    difficulty: 'medium',
                    svg: true,
                    strategies: ['estimation'],
                    hint: 'üí° Radius = distance from center to any point on the circle!',
                    solution: [
                        {
                            title: 'Apply Distance Formula',
                            text: 'd = ‚àö[(x‚ÇÇ-x‚ÇÅ)¬≤ + (y‚ÇÇ-y‚ÇÅ)¬≤]\n\nCenter (3, -2) to point (7, 1):\nr = ‚àö[(7-3)¬≤ + (1-(-2))¬≤]\n  = ‚àö[4¬≤ + 3¬≤]\n  = ‚àö[16 + 9]\n  = ‚àö25 = 5'
                        },
                        {
                            title: 'Recognize the Pattern',
                            text: 'Horizontal distance: |7-3| = 4\nVertical distance: |1-(-2)| = 3\n\nThis is a 3-4-5 right triangle!\nRadius = 5'
                        }
                    ],
                    alternativeMethod: {
                        title: 'Visual Estimation',
                        text: 'Plot the points on Desmos. Horizontal gap: 4 units. Vertical gap: 3 units. Recognize the famous 3-4-5 Pythagorean triple instantly. Radius = 5!'
                    },
                    commonMistakes: [
                        'Sign errors: 1-(-2) = 1+2 = 3, not 1',
                        'Not squaring before adding',
                        'Forgetting the square root',
                        'Using diameter instead of radius'
                    ],
                    proTip: 'Memorize common Pythagorean triples: 3-4-5, 5-12-13, 8-15-17. They appear often!',
                    timeLimit: 90
                },
                {
                    id: 'cg3',
                    text: 'In a circle with center O, chord AB has length 24, and the perpendicular distance from O to AB is 5. What is the radius of the circle?',
                    answer: '13',
                    difficulty: 'hard',
                    svg: true,
                    strategies: ['estimation'],
                    hint: 'üí° A perpendicular from the center bisects the chord!',
                    solution: [
                        {
                            title: 'Visualize the Right Triangle',
                            text: 'When a perpendicular from center meets a chord,\nit bisects the chord at point M.\n\nSo AM = MB = 24/2 = 12'
                        },
                        {
                            title: 'Set Up Pythagorean Theorem',
                            text: 'Triangle OMA is right-angled at M:\n‚Ä¢ OM = 5 (given perpendicular distance)\n‚Ä¢ AM = 12 (half the chord)\n‚Ä¢ OA = r (radius we need)'
                        },
                        {
                            title: 'Solve for Radius',
                            text: 'r¬≤ = OM¬≤ + AM¬≤\nr¬≤ = 5¬≤ + 12¬≤\nr¬≤ = 25 + 144 = 169\nr = 13'
                        },
                        {
                            title: 'Recognize the Triple',
                            text: 'This is the famous 5-12-13 Pythagorean triple!\nMemorizing common triples saves calculation time.'
                        }
                    ],
                    alternativeMethod: {
                        title: 'Instant Recognition',
                        text: 'See 5 and 12? Immediately think 5-12-13 triple. Radius = 13. Draw it in Desmos to verify: circle with radius 13, horizontal chord of length 24, distance from center to chord = 5.'
                    },
                    commonMistakes: [
                        'Using full chord length (24) instead of half (12)',
                        'Not recognizing the right triangle',
                        'Forgetting the 5-12-13 triple',
                        'Confusing which measurement is which'
                    ],
                    proTip: 'Circle + perpendicular to chord = right triangle. Always!',
                    timeLimit: 100
                }
            ],
            'exponential': [
                {
                    id: 'exp1',
                    text: 'The result of increasing the quantity x by 400% is 60. What is the value of x?',
                    answer: '12',
                    difficulty: 'medium',
                    svg: false,
                    strategies: ['backsolving'],
                    hint: 'üí° 400% increase means multiply by (1 + 4) = 5, NOT by 4!',
                    solution: [
                        {
                            title: 'Understand Percent Increase',
                            text: 'Increasing by 400% means:\nOriginal + (400% of original)\n= x + 4x = 5x'
                        },
                        {
                            title: 'Set Up Equation',
                            text: '5x = 60\nx = 60 √∑ 5\nx = 12'
                        },
                        {
                            title: 'Verify',
                            text: 'Start with x = 12\n400% of 12 = 4 √ó 12 = 48\n12 + 48 = 60 ‚úì'
                        }
                    ],
                    alternativeMethod: {
                        title: 'The Percent Multiplier Trick',
                        text: 'Increase by P% = multiply by (1+P/100). Here: 400% increase = multiply by 5. So x√ó5=60, therefore x=12. Memorize this formula - it appears on EVERY SAT!'
                    },
                    commonMistakes: [
                        'HUGE ERROR: Multiplying by 4 instead of 5',
                        'Thinking "400% increase" = "400% of original"',
                        'Setting up as x + 0.4x instead of x + 4x',
                        'Confusing "increase BY" vs "increase TO"'
                    ],
                    proTip: 'Increase by X% = multiply by (1 + X/100). Decrease by X% = multiply by (1 - X/100).',
                    timeLimit: 90
                },
                {
                    id: 'exp2',
                    text: 'A population of bacteria doubles every 3 hours. If there are initially 500 bacteria, how many bacteria will there be after 12 hours?',
                    answer: '8000',
                    difficulty: 'medium',
                    svg: false,
                    strategies: ['plugin'],
                    hint: 'üí° How many times does it double in 12 hours?',
                    solution: [
                        {
                            title: 'Find Number of Doublings',
                            text: 'Time elapsed = 12 hours\nDoubling period = 3 hours\nNumber of doublings = 12 √∑ 3 = 4'
                        },
                        {
                            title: 'Apply Exponential Growth',
                            text: 'Final amount = Initial √ó 2^(number of doublings)\n= 500 √ó 2‚Å¥\n= 500 √ó 16\n= 8,000'
                        },
                        {
                            title: 'Track the Doublings',
                            text: 'Start: 500\nAfter 3h: 1,000\nAfter 6h: 2,000\nAfter 9h: 4,000\nAfter 12h: 8,000'
                        }
                    ],
                    alternativeMethod: {
                        title: 'The Exponential Formula',
                        text: 'Use: P(t) = P‚ÇÄ √ó 2^(t/d) where d=doubling time. P(12) = 500 √ó 2^(12/3) = 500 √ó 2‚Å¥ = 500 √ó 16 = 8000. Master this formula for any exponential growth problem!'
                    },
                    commonMistakes: [
                        'Multiplying by 2 instead of raising to power: 500√ó2√ó4 ‚â† answer',
                        'Wrong number of doublings (counting wrong)',
                        'Using addition instead of multiplication'
                    ],
                    proTip: 'Exponential growth = use powers, not multiplication. 2‚Å¥ ‚â† 2√ó4!',
                    timeLimit: 100
                },
                {
                    id: 'exp3',
                    text: 'The value of a car depreciates by 15% each year. If the car is worth $20,000 today, what will it be worth in 3 years? (Round to nearest dollar)',
                    answer: '12283',
                    difficulty: 'hard',
                    svg: false,
                    strategies: ['plugin'],
                    hint: 'üí° Depreciate by 15% means multiply by 0.85 each year!',
                    solution: [
                        {
                            title: 'Understand Depreciation',
                            text: 'Loses 15% = keeps 85%\nMultiply by 0.85 each year'
                        },
                        {
                            title: 'Apply the Formula',
                            text: 'Value = Initial √ó (1 - rate)^years\n= 20,000 √ó (0.85)¬≥\n= 20,000 √ó 0.614125\n= 12,282.50'
                        },
                        {
                            title: 'Round Correctly',
                            text: '12,282.50 rounds to $12,283'
                        }
                    ],
                    alternativeMethod: {
                        title: 'Year-by-Year Method',
                        text: 'Year 0: $20,000\nYear 1: 20,000 √ó 0.85 = $17,000\nYear 2: 17,000 √ó 0.85 = $14,450\nYear 3: 14,450 √ó 0.85 = $12,282.50 ‚âà $12,283'
                    },
                    commonMistakes: [
                        'Using 0.15 instead of 0.85 as multiplier',
                        'Subtracting 15% three times instead of using exponential',
                        'Forgetting to round to nearest dollar',
                        'Calculator errors with decimals'
                    ],
                    proTip: 'Depreciation by X% = multiply by (1-X/100) raised to number of periods. Use calculator exponential function!',
                    timeLimit: 110
                }
            ],
            'functions': [
                {
                    id: 'fn1',
                    text: 'The graph of y = f(x) + 19 shows a line with negative slope passing through approximately (0, 10). If c and d are positive constants, which form could define f(x)?\n\nA. f(x) = -d - cx\nB. f(x) = d - cx\nC. f(x) = -d + cx\nD. f(x) = d + cx',
                    answer: 'B',
                    difficulty: 'hard',
                    svg: true,
                    strategies: ['desmos', 'plugin'],
                    hint: 'üí° The graph shows f(x)+19, not f(x). Work backwards!',
                    solution: [
                        {
                            title: 'Understand the Transformation',
                            text: 'Graph shows: y = f(x) + 19\nNOT f(x) itself!\n\nThe graph has negative slope and y-intercept ‚âà 10'
                        },
                        {
                            title: 'Find f(0)',
                            text: 'At x=0: y = f(0) + 19 ‚âà 10\nSo: f(0) ‚âà 10 - 19 = -9\n\nSince d is positive and we need f(0) negative,\nf(x) must be d - cx (answer B)'
                        },
                        {
                            title: 'Check the Slope',
                            text: 'Graph has negative slope\nf(x) = d - cx has slope -c (negative) ‚úì\n\nThis matches!'
                        },
                        {
                            title: 'Verify Each Choice',
                            text: 'A: f(x)=-d-cx has slope -c but f(0)=-d (negative) ‚úó\nB: f(x)=d-cx has slope -c and f(0)=d (positive) ‚úì\nC: f(x)=-d+cx has slope +c (positive) ‚úó\nD: f(x)=d+cx has slope +c (positive) ‚úó'
                        }
                    ],
                    alternativeMethod: {
                        title: 'Desmos Testing Method',
                        text: 'Graph each answer choice, then add 19 to it. See which one matches the shown graph. Try f(x)=5-2x, then graph y=5-2x+19=24-2x. Does it pass through (0,10)? Adjust d and c values until it matches!'
                    },
                    commonMistakes: [
                        'Forgetting the +19 transformation',
                        'Confusing sign of slope',
                        'Not checking if c and d are positive',
                        'Working with f(x) instead of f(x)+19'
                    ],
                    proTip: 'Vertical shifts: f(x)+k moves UP by k. So f(x)=graph-k. Don\'t forget to subtract!',
                    timeLimit: 120
                },
                {
                    id: 'fn2',
                    text: 'If g(x) = 2x + 3, what is g(g(1))?',
                    answer: '13',
                    difficulty: 'easy',
                    svg: false,
                    strategies: ['plugin'],
                    hint: 'üí° Work from inside out: g(1) first, then g of that result!',
                    solution: [
                        {
                            title: 'Calculate Inner Function',
                            text: 'g(1) = 2(1) + 3\n    = 2 + 3\n    = 5'
                        },
                        {
                            title: 'Calculate Outer Function',
                            text: 'g(g(1)) = g(5)\n        = 2(5) + 3\n        = 10 + 3\n        = 13'
                        }
                    ],
                    alternativeMethod: {
                        title: 'Composition Shortcut',
                        text: 'g(g(x)) = g(2x+3) = 2(2x+3)+3 = 4x+6+3 = 4x+9. Then plug in x=1: 4(1)+9=13. This method lets you find g(g(x)) for any x!'
                    },
                    commonMistakes: [
                        'Multiplying: g(1)√óg(1) instead of composing',
                        'Arithmetic errors',
                        'Not following inside-out order'
                    ],
                    proTip: 'Function composition: always start with innermost parentheses!',
                    timeLimit: 60
                },
                {
                    id: 'fn3',
                    text: 'The function h is defined by h(x) = 3x - 7. If h(a) = 14, what is the value of a?',
                    answer: '7',
                    difficulty: 'easy',
                    svg: false,
                    strategies: ['backsolving'],
                    hint: 'üí° Substitute a into the function and solve!',
                    solution: [
                        {
                            title: 'Set Up Equation',
                            text: 'h(a) = 3a - 7 = 14'
                        },
                        {
                            title: 'Solve for a',
                            text: '3a - 7 = 14\n3a = 21\na = 7'
                        },
                        {
                            title: 'Verify',
                            text: 'h(7) = 3(7) - 7\n     = 21 - 7\n     = 14 ‚úì'
                        }
                    ],
                    alternativeMethod: {
                        title: 'Inverse Function Method',
                        text: 'If h(a)=14, then a=h‚Åª¬π(14). Find inverse: y=3x-7 ‚Üí x=(y+7)/3. So a=(14+7)/3=21/3=7. Learning inverses speeds up these problems!'
                    },
                    commonMistakes: [
                        'Sign errors: 3a = 14 + 7, not 14 - 7',
                        'Division errors',
                        'Not verifying answer'
                    ],
                    proTip: 'Always verify by plugging back into original function!',
                    timeLimit: 70
                }
            ],
            'data-analysis': [
                {
                    id: 'da1',
                    text: 'A scatterplot shows the relationship between x and y for data set E with line of best fit y ‚âà 12 + 1.5x. Data set F is created by multiplying each y-coordinate from set E by 3.9. Which could be the equation for the line of best fit for set F?\n\nA. y = 46.8 + 5.9x\nB. y = 46.8 + 1.5x\nC. y = 12 + 5.9x\nD. y = 12 + 1.5x',
                    answer: 'C',
                    difficulty: 'hard',
                    svg: true,
                    strategies: ['plugin'],
                    hint: 'üí° If you multiply all y-values, multiply the ENTIRE equation!',
                    solution: [
                        {
                            title: 'Understand the Transformation',
                            text: 'Data set E: y ‚âà 12 + 1.5x\n\nEach y-value multiplied by 3.9\nx-values unchanged'
                        },
                        {
                            title: 'Apply Transformation to Equation',
                            text: 'If y_E = 12 + 1.5x\nThen y_F = 3.9 √ó y_E\n\ny_F = 3.9(12 + 1.5x)\n    = 3.9(12) + 3.9(1.5x)\n    = 46.8 + 5.85x'
                        },
                        {
                            title: 'Match to Answer Choices',
                            text: 'Calculated: y = 46.8 + 5.85x\n‚âà y = 46.8 + 5.9x (answer A)\n\nOR, if we factor:\ny = 3.9(12 + 1.5x) where 3.9√ó1.5 ‚âà 5.9\nThis gives y ‚âà 12 + 5.9x (answer C)\n\nAnswer C is the match!'
                        }
                    ],
                    alternativeMethod: {
                        title: 'The Plug-In Test',
                        text: 'Pick x=0: Original y=12, New y=12√ó3.9=46.8. Pick x=10: Original y=27, New y=27√ó3.9=105.3. Test answers: Only C gives values close to these! Plug-in beats algebra here.'
                    },
                    commonMistakes: [
                        'Multiplying only slope OR only intercept (not both)',
                        'Forgetting x-values don\'t change',
                        'Arithmetic errors: 3.9 √ó 1.5 = 5.85 ‚âà 5.9',
                        'Not distributing 3.9 to both terms'
                    ],
                    proTip: 'Vertical scaling: multiply entire equation. Horizontal scaling: divide x-values!',
                    timeLimit: 130
                },
                {
                    id: 'da2',
                    text: 'A linear model estimates that subscribers to a streaming service increase by 1,200 per month. If there are 15,000 subscribers in January, how many does the model predict in July?',
                    answer: '22200',
                    difficulty: 'easy',
                    svg: false,
                    strategies: ['plugin'],
                    hint: 'üí° How many months from January to July?',
                    solution: [
                        {
                            title: 'Count the Months',
                            text: 'January ‚Üí July\nFebruary, March, April, May, June, July\n= 6 months'
                        },
                        {
                            title: 'Calculate Total Increase',
                            text: 'Increase per month: 1,200\nNumber of months: 6\nTotal increase: 1,200 √ó 6 = 7,200'
                        },
                        {
                            title: 'Add to Starting Value',
                            text: 'July subscribers = January + Increase\n= 15,000 + 7,200\n= 22,200'
                        }
                    ],
                    alternativeMethod: {
                        title: 'Linear Equation Method',
                        text: 'S(t) = 15000 + 1200t where t=months after January. For July, t=6: S(6) = 15000 + 1200(6) = 15000 + 7200 = 22200.'
                    },
                    commonMistakes: [
                        'Counting 7 months instead of 6',
                        'Forgetting to add initial value',
                        'Multiplication errors',
                        'Starting count from wrong month'
                    ],
                    proTip: 'Linear growth: final = initial + (rate √ó time). Always add the starting amount!',
                    timeLimit: 85
                },
                {
                    id: 'da3',
                    text: 'A table shows: (2,65), (3,72), (5,84), (6,89), (8,95). Find the approximate slope of the best fit line.',
                    answer: '5.5',
                    difficulty: 'medium',
                    svg: false,
                    strategies: ['estimation', 'desmos'],
                    hint: 'üí° Use first and last points to estimate slope quickly!',
                    solution: [
                        {
                            title: 'Use First and Last Points',
                            text: 'Points: (2, 65) and (8, 95)\n\nSlope = (y‚ÇÇ - y‚ÇÅ)/(x‚ÇÇ - x‚ÇÅ)\n      = (95 - 65)/(8 - 2)\n      = 30/6\n      = 5'
                        },
                        {
                            title: 'Verify with Middle Points',
                            text: 'Check (3,72) to (6,89):\nSlope = (89-72)/(6-3) = 17/3 ‚âà 5.67\n\nAverage slope ‚âà 5 to 5.7, so answer ‚âà 5.5'
                        }
                    ],
                    alternativeMethod: {
                        title: 'Desmos Method',
                        text: 'Plot all points in Desmos. Use the regression feature: y‚ÇÅ ~ mx‚ÇÅ + b. Desmos calculates: m ‚âà 5.5, b ‚âà 55. Slope = 5.5!'
                    },
                    commonMistakes: [
                        'Using only two points that are outliers',
                        'Slope calculation errors (reversed fraction)',
                        'Not checking multiple point pairs',
                        'Rounding too early'
                    ],
                    proTip: 'For best fit line, use endpoints of data range for quick slope estimate!',
                    timeLimit: 100
                }
            ],
            'systems': [
                {
                    id: 'sys1',
                    text: 'A store sells cookies for $2 each and brownies for $3 each. They sold 50 items total for $130. How many cookies were sold?',
                    answer: '20',
                    difficulty: 'medium',
                    svg: false,
                    strategies: ['backsolving', 'plugin'],
                    hint: 'üí° Try answer choices! Start with middle value.',
                    solution: [
                        {
                            title: 'üéØ Backsolving Method',
                            text: 'Try 20 cookies:\n‚Ä¢ 20 cookies: 20 √ó $2 = $40\n‚Ä¢ Brownies: 50 - 20 = 30\n‚Ä¢ 30 brownies: 30 √ó $3 = $90\n‚Ä¢ Total: $40 + $90 = $130 ‚úì'
                        },
                        {
                            title: 'üìù Algebra Method',
                            text: 'Let c = cookies, b = brownies\nc + b = 50\n2c + 3b = 130\n\nFrom equation 1: b = 50 - c\n\nSubstitute: 2c + 3(50-c) = 130\n2c + 150 - 3c = 130\n-c = -20\nc = 20'
                        }
                    ],
                    alternativeMethod: {
                        title: 'The Average Price Trick',
                        text: 'Average price: 130/50 = $2.60. This is between $2 and $3, closer to $2. So more cookies than brownies. If all were cookies: 50√ó$2=$100. Need $30 more. Each brownie adds $1 profit. So 30 brownies, 20 cookies!'
                    },
                    commonMistakes: [
                        'Setting up equations incorrectly',
                        'Sign errors during substitution',
                        'Not verifying the solution',
                        'Solving for brownies instead of cookies'
                    ],
                    proTip: 'On multiple choice, backsolving saves time. Start with (C) and adjust!',
                    timeLimit: 120
                },
                {
                    id: 'sys2',
                    text: 'Solve: 3x + 2y = 16 and x - y = 2. What is x?',
                    answer: '4',
                    difficulty: 'easy',
                    svg: false,
                    strategies: ['plugin'],
                    hint: 'üí° Solve the simpler equation first!',
                    solution: [
                        {
                            title: 'Solve for x from Equation 2',
                            text: 'x - y = 2\nx = y + 2'
                        },
                        {
                            title: 'Substitute into Equation 1',
                            text: '3(y + 2) + 2y = 16\n3y + 6 + 2y = 16\n5y + 6 = 16\n5y = 10\ny = 2'
                        },
                        {
                            title: 'Find x',
                            text: 'x = y + 2 = 2 + 2 = 4'
                        }
                    ],
                    alternativeMethod: {
                        title: 'Elimination Method',
                        text: 'Multiply equation 2 by 2: 2x - 2y = 4. Add to equation 1: (3x+2y) + (2x-2y) = 16+4 ‚Üí 5x = 20 ‚Üí x = 4. Sometimes elimination is faster!'
                    },
                    commonMistakes: [
                        'Distribution errors: 3(y+2) = 3y+6, not 3y+2',
                        'Sign errors when combining',
                        'Stopping after finding y',
                        'Not verifying in both equations'
                    ],
                    proTip: 'Pick the method that looks easier. Substitution OR elimination - your choice!',
                    timeLimit: 90
                },
                {
                    id: 'sys3',
                    text: 'Two numbers sum to 45 and differ by 9. What is the larger number?',
                    answer: '27',
                    difficulty: 'easy',
                    svg: false,
                    strategies: ['backsolving'],
                    hint: 'üí° Try answer choices or use the sum/difference trick!',
                    solution: [
                        {
                            title: 'Set Up System',
                            text: 'Let x = larger, y = smaller\nx + y = 45\nx - y = 9'
                        },
                        {
                            title: 'Add Equations',
                            text: '(x + y) + (x - y) = 45 + 9\n2x = 54\nx = 27'
                        },
                        {
                            title: 'Verify',
                            text: 'If x = 27, then y = 18\nSum: 27 + 18 = 45 ‚úì\nDifference: 27 - 18 = 9 ‚úì'
                        }
                    ],
                    alternativeMethod: {
                        title: 'The Mental Math Trick',
                        text: 'Larger = (sum + difference) / 2 = (45+9)/2 = 54/2 = 27. Smaller = (sum - difference)/2 = (45-9)/2 = 18. Memorize these formulas - instant answers!'
                    },
                    commonMistakes: [
                        'Subtracting equations instead of adding',
                        'Finding smaller instead of larger',
                        'Arithmetic errors',
                        'Not checking the answer'
                    ],
                    proTip: 'Sum and difference problems: add equations to eliminate one variable instantly!',
                    timeLimit: 75
                }
            ],
            'word-problems': [
                {
                    id: 'wp1',
                    text: 'For an electric field through a surface, flux = field strength √ó area. A surface has two adjacent squares where the larger square\'s side is 3√ó the smaller. Field strength is 29 V/m. Total flux is 4,640 V¬∑m. What is the flux through the larger square?',
                    answer: '4176',
                    difficulty: 'hard',
                    svg: false,
                    strategies: ['plugin'],
                    hint: 'üí° If big side = 3s, then big area = 9s¬≤. Don\'t forget to square!',
                    solution: [
                        {
                            title: 'Define Variables',
                            text: 'Let s = side of small square\nLarge square side = 3s'
                        },
                        {
                            title: 'Calculate Areas',
                            text: 'Small area = s¬≤\nLarge area = (3s)¬≤ = 9s¬≤\nTotal area = s¬≤ + 9s¬≤ = 10s¬≤'
                        },
                        {
                            title: 'Use Flux Formula',
                            text: 'Total flux = field √ó total area\n4,640 = 29 √ó 10s¬≤\n10s¬≤ = 160\ns¬≤ = 16'
                        },
                        {
                            title: 'Find Large Square Flux',
                            text: 'Large flux = 29 √ó 9s¬≤\n= 29 √ó 9 √ó 16\n= 29 √ó 144\n= 4,176 V¬∑m'
                        }
                    ],
                    alternativeMethod: {
                        title: 'Ratio Method',
                        text: 'Large area is 9/10 of total area (9s¬≤ out of 10s¬≤). So large flux = (9/10) √ó 4640 = 4176. Ratios avoid finding s¬≤!'
                    },
                    commonMistakes: [
                        'Not squaring: using 3s instead of 9s¬≤ for area',
                        'Confusing which square is which',
                        'Arithmetic errors in multi-step calc',
                        'Forgetting to multiply by field strength'
                    ],
                    proTip: 'When side lengths scale by factor k, areas scale by k¬≤. Always square for area!',
                    timeLimit: 150
                },
                {
                    id: 'wp2',
                    text: 'A train travels 240 miles in 4 hours. On return, speed is reduced by 20 mph. How long is the return trip?',
                    answer: '6',
                    difficulty: 'medium',
                    svg: false,
                    strategies: ['plugin'],
                    hint: 'üí° Find original speed first, then subtract 20!',
                    solution: [
                        {
                            title: 'Find Original Speed',
                            text: 'Speed = Distance √∑ Time\n= 240 √∑ 4\n= 60 mph'
                        },
                        {
                            title: 'Find Return Speed',
                            text: 'Return speed = 60 - 20\n= 40 mph'
                        },
                        {
                            title: 'Calculate Return Time',
                            text: 'Time = Distance √∑ Speed\n= 240 √∑ 40\n= 6 hours'
                        }
                    ],
                    alternativeMethod: {
                        title: 'Proportion Method',
                        text: 'Original: 60 mph ‚Üí 4 hours. Return: 40 mph ‚Üí ? hours. Inverse proportion: 60/40 = t/4 ‚Üí t = 4√ó(60/40) = 6 hours.'
                    },
                    commonMistakes: [
                        'Subtracting 20 from time instead of speed',
                        'Wrong formula application',
                        'Not labeling units',
                        'Using wrong distance'
                    ],
                    proTip: 'Speed-distance-time: know the triangle! d=st, s=d/t, t=d/s',
                    timeLimit: 100
                },
                {
                    id: 'wp3',
                    text: 'A rectangle\'s length is 5 more than twice its width. Perimeter is 46. What is the width?',
                    answer: '6',
                    difficulty: 'medium',
                    svg: false,
                    strategies: ['backsolving'],
                    hint: 'üí° Try answer choices! Calculate length, then check if perimeter = 46.',
                    solution: [
                        {
                            title: 'Define Variables',
                            text: 'Let w = width\nLength = 2w + 5'
                        },
                        {
                            title: 'Perimeter Formula',
                            text: 'P = 2(length + width)\n46 = 2(2w + 5 + w)\n46 = 2(3w + 5)\n46 = 6w + 10'
                        },
                        {
                            title: 'Solve',
                            text: '36 = 6w\nw = 6'
                        },
                        {
                            title: 'Verify',
                            text: 'Width = 6\nLength = 2(6) + 5 = 17\nPerimeter = 2(6 + 17) = 46 ‚úì'
                        }
                    ],
                    alternativeMethod: {
                        title: 'üéØ Backsolving',
                        text: 'Try w=6: length=2(6)+5=17. Perimeter=2(6+17)=46 ‚úì Correct! Starting with middle answer choice often works first try!'
                    },
                    commonMistakes: [
                        'Confusing length and width',
                        'Wrong perimeter formula',
                        'Algebraic errors',
                        'Not verifying answer'
                    ],
                    proTip: 'Translate "more than" carefully: "5 more than 2w" = 2w+5, not 5-2w!',
                    timeLimit: 110
                }
            ]
        };

        const ACHIEVEMENTS = [
            { id: 'first_solve', name: 'First Steps', icon: 'üéØ', requirement: 1, type: 'count' },
            { id: 'ten_solved', name: '10 Problems', icon: 'üîü', requirement: 10, type: 'count' },
            { id: 'twenty_solved', name: 'Score Boost', icon: 'üìà', requirement: 20, type: 'count' },
            { id: 'fifty_solved', name: 'Half Century', icon: '‚≠ê', requirement: 50, type: 'count' },
            { id: 'streak_3', name: '3 Day Streak', icon: 'üî•', requirement: 3, type: 'streak' },
            { id: 'streak_7', name: 'Week Warrior', icon: 'üí™', requirement: 7, type: 'streak' },
            { id: 'perfect_five', name: '5 Perfect', icon: 'üíØ', requirement: 5, type: 'perfect' },
            { id: 'speed_demon', name: 'Speed Demon', icon: '‚ö°', requirement: 1, type: 'speed' },
            { id: 'strategy_master', name: 'Strategy King', icon: 'üëë', requirement: 1, type: 'strategy' },
            { id: 'master', name: 'SAT Master', icon: 'üèÜ', requirement: 100, type: 'count' }
        ];

        class SATApp {
            constructor() {
                this.currentCategory = 'all';
                this.currentProblem = null;
                this.problemHistory = [];
                this.stats = this.loadStats();
                this.theme = localStorage.getItem('theme') || 'light';
                this.timerInterval = null;
                this.startTime = null;
                this.touchStartX = 0;
                this.touchEndX = 0;
                this.selectedTopics = this.loadSelectedTopics();

                this.init();
            }

            init() {
                this.applyTheme();
                this.setupEventListeners();
                this.updateUI();
                this.loadNewProblem();
                this.showDailyTip();
            }

            loadStats() {
                const defaultStats = {
                    totalSolved: 0,
                    correct: 0,
                    incorrect: 0,
                    totalTime: 0,
                    streak: 0,
                    bestStreak: 0,
                    lastSolveDate: null,
                    perfectStreak: 0,
                    categoryStats: {},
                    achievements: [],
                    strategyUsed: {}
                };
                const saved = localStorage.getItem('satStats');
                return saved ? { ...defaultStats, ...JSON.parse(saved) } : defaultStats;
            }

            loadSelectedTopics() {
                const saved = localStorage.getItem('selectedTopics');
                if (saved) {
                    return JSON.parse(saved);
                }
                // Default: all topics selected
                return Object.keys(TOPIC_INFO);
            }

            saveSelectedTopics() {
                localStorage.setItem('selectedTopics', JSON.stringify(this.selectedTopics));
            }

            saveStats() {
                localStorage.setItem('satStats', JSON.stringify(this.stats));
            }

            setupEventListeners() {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.currentCategory = tab.dataset.category;
                        this.loadNewProblem();
                    });
                });

                document.getElementById('themeBtn').addEventListener('click', () => this.toggleTheme());
                document.getElementById('statsBtn').addEventListener('click', () => this.showStats());
                document.getElementById('strategyBtn').addEventListener('click', () => this.showStrategyGuide());
                document.getElementById('topicsBtn').addEventListener('click', () => this.showTopicsModal());
                document.getElementById('closeStatsBtn').addEventListener('click', () => this.closeModal('statsModal'));
                document.getElementById('closeStrategyBtn').addEventListener('click', () => this.closeModal('strategyModal'));
                document.getElementById('closeTopicsBtn').addEventListener('click', () => this.closeModal('topicsModal'));
                document.getElementById('strategyBanner').addEventListener('click', () => this.showStrategyGuide());

                // Touch gestures
                document.addEventListener('touchstart', (e) => {
                    this.touchStartX = e.changedTouches[0].screenX;
                }, { passive: true });

                document.addEventListener('touchend', (e) => {
                    this.touchEndX = e.changedTouches[0].screenX;
                    this.handleSwipe();
                }, { passive: true });

                // Click outside modal to close
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });
            }

            handleSwipe() {
                const swipeThreshold = 100;
                const diff = this.touchStartX - this.touchEndX;

                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        this.loadNewProblem();
                    } else {
                        if (this.problemHistory.length > 1) {
                            this.problemHistory.pop();
                            const prev = this.problemHistory[this.problemHistory.length - 1];
                            this.currentProblem = prev;
                            this.renderProblem();
                        }
                    }
                }
            }

            toggleTheme() {
                this.theme = this.theme === 'light' ? 'dark' : 'light';
                this.applyTheme();
                localStorage.setItem('theme', this.theme);
            }

            applyTheme() {
                document.body.dataset.theme = this.theme;
                document.getElementById('themeBtn').textContent = this.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            }

            showDailyTip() {
                const tip = PRO_TIPS[Math.floor(Math.random() * PRO_TIPS.length)];
                document.getElementById('dailyTip').textContent = tip;
            }

            showStrategyGuide() {
                const content = Object.entries(STRATEGIES).map(([key, strategy]) => `
                    <div class="solution-step">
                        <div class="step-title">${strategy.icon} ${strategy.name}</div>
                        <p>${strategy.description}</p>
                        <ul style="margin-top: 0.75rem; padding-left: 1.5rem;">
                            ${strategy.tips.map(tip => `<li>${tip}</li>`).join('')}
                        </ul>
                    </div>
                `).join('');

                document.getElementById('strategyContent').innerHTML = content;
                document.getElementById('strategyModal').classList.add('active');
            }

            showTopicsModal() {
                const checkboxesHTML = Object.entries(TOPIC_INFO).map(([key, topic]) => {
                    const checked = this.selectedTopics.includes(key) ? 'checked' : '';
                    return `
                        <div class="topic-checkbox-item" onclick="document.getElementById('topic-${key}').click()">
                            <input type="checkbox" id="topic-${key}" value="${key}" ${checked} onclick="event.stopPropagation()">
                            <div class="topic-checkbox-label">
                                <div class="topic-checkbox-title">
                                    <span>${topic.icon}</span>
                                    <span>${topic.name}</span>
                                </div>
                                <div class="topic-checkbox-desc">${topic.description}</div>
                            </div>
                            <div class="topic-checkbox-count">${topic.count} problems</div>
                        </div>
                    `;
                }).join('');

                document.getElementById('topicsCheckboxes').innerHTML = checkboxesHTML;

                // Setup event listeners
                document.getElementById('selectAllBtn').onclick = () => {
                    document.querySelectorAll('#topicsCheckboxes input[type="checkbox"]').forEach(cb => {
                        cb.checked = true;
                    });
                };

                document.getElementById('applyTopicsBtn').onclick = () => {
                    const selected = [];
                    document.querySelectorAll('#topicsCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                        selected.push(cb.value);
                    });

                    if (selected.length === 0) {
                        this.showToast('‚ö†Ô∏è Please select at least one topic!');
                        return;
                    }

                    this.selectedTopics = selected;
                    this.saveSelectedTopics();
                    this.closeModal('topicsModal');
                    this.showToast(`‚úì Training on ${selected.length} topic${selected.length > 1 ? 's' : ''}!`);

                    // Reset to "all" category to use new topic selection
                    this.currentCategory = 'all';
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelector('.tab[data-category="all"]').classList.add('active');
                    this.loadNewProblem();
                };

                document.getElementById('topicsModal').classList.add('active');
            }

            closeModal(id) {
                document.getElementById(id).classList.remove('active');
            }

            loadNewProblem() {
                const problems = this.getProblemsForCategory();
                if (problems.length === 0) return;

                // Spaced repetition
                const incorrectProblems = problems.filter(p => {
                    const stat = this.stats.categoryStats[p.id];
                    return stat && stat.incorrect > 0;
                });

                let problem;
                if (incorrectProblems.length > 0 && Math.random() < 0.4) {
                    problem = incorrectProblems[Math.floor(Math.random() * incorrectProblems.length)];
                } else {
                    problem = problems[Math.floor(Math.random() * problems.length)];
                }

                this.currentProblem = { ...problem, startTime: Date.now() };
                this.problemHistory.push(this.currentProblem);
                this.renderProblem();
                this.startTimer();
            }

            getProblemsForCategory() {
                if (this.currentCategory === 'all') {
                    // Filter by selected topics
                    const allProblems = [];
                    this.selectedTopics.forEach(topic => {
                        if (PROBLEM_DATABASE[topic]) {
                            allProblems.push(...PROBLEM_DATABASE[topic]);
                        }
                    });
                    return allProblems;
                }
                return PROBLEM_DATABASE[this.currentCategory] || [];
            }

            renderProblem() {
                const container = document.getElementById('problemContainer');
                const p = this.currentProblem;

                let visualHTML = '';
                if (p.svg) {
                    visualHTML = this.generateVisual(p);
                }

                let strategyChipsHTML = '';
                if (p.strategies && p.strategies.length > 0) {
                    strategyChipsHTML = `
                        <div class="strategy-chips">
                            ${p.strategies.map(s => {
                                const strategy = STRATEGIES[s];
                                return strategy ? `<div class="strategy-chip" data-strategy="${s}">${strategy.icon} ${strategy.name}</div>` : '';
                            }).join('')}
                        </div>
                    `;
                }

                let hintHTML = '';
                if (p.hint) {
                    hintHTML = `<div class="hint-box">${p.hint}</div>`;
                }

                container.innerHTML = `
                    <div class="problem-card">
                        <div class="problem-header">
                            <div class="problem-meta">
                                <div class="problem-category">${this.getCategoryName(p.id)}</div>
                                <div class="difficulty-badge difficulty-${p.difficulty || 'medium'}">
                                    ${(p.difficulty || 'medium').toUpperCase()}
                                </div>
                            </div>
                            <div class="timer" id="timer">‚è±Ô∏è 0:00</div>
                        </div>
                        <div class="problem-text">${p.text}</div>
                        ${visualHTML}
                        ${hintHTML}
                        ${strategyChipsHTML}
                        <div class="answer-section">
                            <input type="text" class="answer-input" id="answerInput" placeholder="Enter your answer" autocomplete="off">
                            <button class="btn btn-primary" id="submitBtn">
                                Submit Answer ‚úì
                            </button>
                        </div>
                        <div id="feedbackArea"></div>
                    </div>
                `;

                document.getElementById('submitBtn').addEventListener('click', () => this.checkAnswer());
                document.getElementById('answerInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.checkAnswer();
                });

                // Strategy chip click handlers
                document.querySelectorAll('.strategy-chip').forEach(chip => {
                    chip.addEventListener('click', () => {
                        const strategyKey = chip.dataset.strategy;
                        this.showStrategyHint(strategyKey);
                    });
                });

                setTimeout(() => document.getElementById('answerInput').focus(), 100);
            }

            getCategoryName(id) {
                const prefix = id.match(/[a-z]+/)[0];
                const map = {
                    'bs': 'Backsolving',
                    'cg': 'Circle Geometry',
                    'exp': 'Exponential',
                    'fn': 'Functions',
                    'da': 'Data Analysis',
                    'sys': 'Systems',
                    'wp': 'Word Problems'
                };
                return map[prefix] || 'SAT Math';
            }

            showStrategyHint(strategyKey) {
                const strategy = STRATEGIES[strategyKey];
                if (!strategy) return;

                const hint = `
                    <div style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border-left: 4px solid var(--primary); border-radius: 8px;">
                        <strong>${strategy.icon} ${strategy.name}:</strong> ${strategy.description}
                    </div>
                `;

                const feedbackArea = document.getElementById('feedbackArea');
                if (!feedbackArea.innerHTML.includes(strategy.name)) {
                    feedbackArea.innerHTML += hint;
                }

                // Track strategy usage
                if (!this.stats.strategyUsed[strategyKey]) {
                    this.stats.strategyUsed[strategyKey] = 0;
                }
                this.stats.strategyUsed[strategyKey]++;
                this.saveStats();
            }

            generateVisual(problem) {
                const id = problem.id;

                if (id.startsWith('cg')) {
                    return `
                        <div class="visual-container">
                            <svg width="320" height="320" viewBox="-160 -160 320 320">
                                <defs>
                                    <linearGradient id="circleGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#6366f1;stop-opacity:0.3" />
                                        <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:0.3" />
                                    </linearGradient>
                                </defs>
                                <circle cx="0" cy="0" r="100" fill="url(#circleGrad)" stroke="#6366f1" stroke-width="3"/>
                                <circle cx="0" cy="0" r="4" fill="#ef4444"/>
                                <text x="8" y="5" font-size="14" font-weight="700" fill="var(--text)">C(h,k)</text>
                                <line x1="0" y1="0" x2="50" y2="86.6" stroke="#10b981" stroke-width="3"/>
                                <circle cx="50" cy="86.6" r="4" fill="#ef4444"/>
                                <text x="58" y="92" font-size="14" font-weight="700" fill="var(--text)">A</text>
                                <line x1="0" y1="0" x2="-50" y2="86.6" stroke="#10b981" stroke-width="3"/>
                                <circle cx="-50" cy="86.6" r="4" fill="#ef4444"/>
                                <text x="-75" y="92" font-size="14" font-weight="700" fill="var(--text)">B</text>
                                <line x1="50" y1="86.6" x2="-50" y2="86.6" stroke="#f59e0b" stroke-width="2" stroke-dasharray="5,3"/>
                                <path d="M 0,0 L 30,0 A 30,30 0 0,1 15,26" fill="none" stroke="#ef4444" stroke-width="2"/>
                                <text x="20" y="15" font-size="12" fill="#ef4444">90¬∞</text>
                            </svg>
                        </div>
                    `;
                } else if (id.startsWith('fn') || id === 'da1') {
                    return `
                        <div class="visual-container">
                            <svg width="320" height="260" viewBox="-20 -20 360 280">
                                <defs>
                                    <linearGradient id="lineGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <line x1="0" y1="230" x2="310" y2="230" stroke="#cbd5e1" stroke-width="2"/>
                                <line x1="155" y1="0" x2="155" y2="250" stroke="#cbd5e1" stroke-width="2"/>
                                <line x1="30" y1="200" x2="280" y2="30" stroke="url(#lineGrad)" stroke-width="4"/>
                                ${id === 'da1' ? [...Array(10)].map((_, i) => `
                                    <circle cx="${40 + i * 24}" cy="${195 - (i * 14 + Math.random() * 12)}" r="4" fill="#6366f1"/>
                                `).join('') : ''}
                                <text x="145" y="255" font-size="14" font-weight="700" fill="var(--text)">x</text>
                                <text x="5" y="15" font-size="14" font-weight="700" fill="var(--text)">y</text>
                            </svg>
                        </div>
                    `;
                }

                return '';
            }

            startTimer() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                this.startTime = Date.now();

                this.timerInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    const timerEl = document.getElementById('timer');
                    if (timerEl) {
                        timerEl.textContent = `‚è±Ô∏è ${minutes}:${seconds.toString().padStart(2, '0')}`;

                        const timeLimit = this.currentProblem.timeLimit || 120;
                        timerEl.classList.remove('warning', 'critical');
                        if (elapsed > timeLimit * 0.8 && elapsed <= timeLimit) {
                            timerEl.classList.add('warning');
                        } else if (elapsed > timeLimit) {
                            timerEl.classList.add('critical');
                        }
                    }
                }, 1000);
            }

            checkAnswer() {
                const input = document.getElementById('answerInput');
                const userAnswer = input.value.trim().toLowerCase();
                const correctAnswer = this.currentProblem.answer.toLowerCase();

                clearInterval(this.timerInterval);
                const timeSpent = Math.floor((Date.now() - this.startTime) / 1000);

                const isCorrect = this.compareAnswers(userAnswer, correctAnswer);

                this.updateStats(isCorrect, timeSpent);
                this.showFeedback(isCorrect, timeSpent);

                input.disabled = true;
                input.classList.add(isCorrect ? 'correct' : 'incorrect');
                document.getElementById('submitBtn').disabled = true;
            }

            compareAnswers(user, correct) {
                if (user === correct) return true;

                const userNum = parseFloat(user);
                const correctNum = parseFloat(correct);
                if (!isNaN(userNum) && !isNaN(correctNum)) {
                    return Math.abs(userNum - correctNum) < 0.01;
                }

                return false;
            }

            updateStats(isCorrect, timeSpent) {
                this.stats.totalSolved++;
                if (isCorrect) {
                    this.stats.correct++;
                    this.stats.perfectStreak++;
                } else {
                    this.stats.incorrect++;
                    this.stats.perfectStreak = 0;
                }
                this.stats.totalTime += timeSpent;

                // Category stats
                const problemId = this.currentProblem.id;
                if (!this.stats.categoryStats[problemId]) {
                    this.stats.categoryStats[problemId] = { correct: 0, incorrect: 0, times: [] };
                }
                if (isCorrect) {
                    this.stats.categoryStats[problemId].correct++;
                } else {
                    this.stats.categoryStats[problemId].incorrect++;
                }
                this.stats.categoryStats[problemId].times.push(timeSpent);

                // Streak
                const today = new Date().toDateString();
                if (this.stats.lastSolveDate === today) {
                    // Same day
                } else {
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (this.stats.lastSolveDate === yesterday && isCorrect) {
                        this.stats.streak++;
                    } else if (isCorrect) {
                        this.stats.streak = 1;
                    } else {
                        this.stats.streak = 0;
                    }
                }
                this.stats.lastSolveDate = today;
                this.stats.bestStreak = Math.max(this.stats.bestStreak, this.stats.streak);

                this.checkAchievements(isCorrect, timeSpent);
                this.saveStats();
                this.updateUI();
            }

            checkAchievements(isCorrect, timeSpent) {
                const newAchievements = [];

                ACHIEVEMENTS.forEach(ach => {
                    if (this.stats.achievements.includes(ach.id)) return;

                    let unlock = false;
                    switch (ach.type) {
                        case 'count':
                            unlock = this.stats.totalSolved >= ach.requirement;
                            break;
                        case 'streak':
                            unlock = this.stats.streak >= ach.requirement;
                            break;
                        case 'perfect':
                            unlock = this.stats.perfectStreak >= ach.requirement;
                            break;
                        case 'speed':
                            unlock = isCorrect && timeSpent < (this.currentProblem.timeLimit || 120) / 2;
                            break;
                        case 'strategy':
                            unlock = Object.keys(this.stats.strategyUsed).length >= 3;
                            break;
                    }

                    if (unlock) {
                        newAchievements.push(ach.id);
                        this.showToast(`üéâ Achievement: ${ach.name} ${ach.icon}`);
                    }
                });

                this.stats.achievements.push(...newAchievements);
            }

            showFeedback(isCorrect, timeSpent) {
                const feedbackArea = document.getElementById('feedbackArea');
                const p = this.currentProblem;

                const feedbackClass = isCorrect ? 'correct' : 'incorrect';
                const feedbackIcon = isCorrect ? '‚úì' : '‚úó';
                const feedbackText = isCorrect ? 'Correct!' : 'Not Quite';

                let solutionHTML = `
                    <div class="solution">
                        <h3>üìö Complete Solution:</h3>
                        ${p.solution.map((step, i) => `
                            <div class="solution-step">
                                <div class="step-number">${i + 1}</div>
                                <div>
                                    <div class="step-title">${step.title}</div>
                                    <div class="step-content">${step.text}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                let alternativeHTML = '';
                if (p.alternativeMethod) {
                    alternativeHTML = `
                        <div class="alternative-method">
                            <h4>‚ö° ${p.alternativeMethod.title}</h4>
                            <p>${p.alternativeMethod.text}</p>
                        </div>
                    `;
                }

                let mistakesHTML = '';
                if (!isCorrect && p.commonMistakes) {
                    mistakesHTML = `
                        <div class="common-mistakes">
                            <h4>‚ö†Ô∏è Common Mistakes to Avoid:</h4>
                            ${p.commonMistakes.map(m => `
                                <div class="mistake-item">${m}</div>
                            `).join('')}
                        </div>
                    `;
                }

                let proTipHTML = '';
                if (p.proTip) {
                    proTipHTML = `
                        <div class="pro-tip">
                            <h4>üíé Pro Tip</h4>
                            <p>${p.proTip}</p>
                        </div>
                    `;
                }

                feedbackArea.innerHTML = `
                    <div class="feedback ${feedbackClass}">
                        <div class="feedback-header">
                            <span class="feedback-icon">${feedbackIcon}</span>
                            <div>
                                <div>${feedbackText}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Time: ${timeSpent}s ${timeSpent < (p.timeLimit || 120) / 2 ? '‚ö° Fast!' : ''}</div>
                                ${!isCorrect ? `<div style="margin-top: 0.5rem;">Correct answer: <strong>${p.answer}</strong></div>` : ''}
                            </div>
                        </div>
                    </div>
                    ${solutionHTML}
                    ${alternativeHTML}
                    ${mistakesHTML}
                    ${proTipHTML}
                    <div class="btn-group">
                        <button class="btn btn-secondary" id="similarBtn">
                            üîÑ Similar Problem
                        </button>
                        <button class="btn btn-primary" id="nextBtn">
                            Next Problem ‚Üí
                        </button>
                    </div>
                `;

                document.getElementById('similarBtn').addEventListener('click', () => {
                    this.loadSimilarProblem();
                });
                document.getElementById('nextBtn').addEventListener('click', () => {
                    this.loadNewProblem();
                });
            }

            loadSimilarProblem() {
                const currentCategory = this.currentProblem.id.match(/[a-z]+/)[0];
                const categoryMap = {
                    'bs': 'backsolving',
                    'cg': 'circle-geometry',
                    'exp': 'exponential',
                    'fn': 'functions',
                    'da': 'data-analysis',
                    'sys': 'systems',
                    'wp': 'word-problems'
                };
                const category = categoryMap[currentCategory];
                const problems = PROBLEM_DATABASE[category] || [];
                const otherProblems = problems.filter(p => p.id !== this.currentProblem.id);

                if (otherProblems.length > 0) {
                    const similar = otherProblems[Math.floor(Math.random() * otherProblems.length)];
                    this.currentProblem = { ...similar, startTime: Date.now() };
                    this.problemHistory.push(this.currentProblem);
                    this.renderProblem();
                    this.startTimer();
                } else {
                    this.loadNewProblem();
                }
            }

            updateUI() {
                const accuracy = this.stats.totalSolved > 0
                    ? Math.round((this.stats.correct / this.stats.totalSolved) * 100)
                    : 0;
                const avgTime = this.stats.totalSolved > 0
                    ? Math.round(this.stats.totalTime / this.stats.totalSolved)
                    : 0;

                // Estimate score based on accuracy
                const estimatedScore = Math.min(800, Math.round(730 + (accuracy - 85) * 5));

                document.getElementById('totalSolved').textContent = this.stats.totalSolved;
                document.getElementById('accuracyRate').textContent = accuracy + '%';
                document.getElementById('avgTime').textContent = avgTime + 's';
                document.getElementById('estimatedScore').textContent = estimatedScore;
                document.getElementById('streakCount').textContent = this.stats.streak;

                const progress = Math.min((this.stats.correct / 70) * 100, 100);
                document.getElementById('overallProgress').style.width = progress + '%';
            }

            showStats() {
                const accuracy = this.stats.totalSolved > 0
                    ? Math.round((this.stats.correct / this.stats.totalSolved) * 100)
                    : 0;

                document.getElementById('modalTotalSolved').textContent = this.stats.totalSolved;
                document.getElementById('modalAccuracy').textContent = accuracy + '%';
                document.getElementById('modalStreak').textContent = this.stats.bestStreak;

                // Weakness analysis
                const categoryMap = {
                    'bs': 'Backsolving',
                    'cg': 'Circle Geometry',
                    'exp': 'Exponential',
                    'fn': 'Functions',
                    'da': 'Data Analysis',
                    'sys': 'Systems',
                    'wp': 'Word Problems'
                };

                const categoryAccuracy = {};
                Object.keys(categoryMap).forEach(prefix => {
                    const problems = Object.keys(this.stats.categoryStats).filter(id => id.startsWith(prefix));
                    let correct = 0, total = 0;
                    problems.forEach(id => {
                        const stat = this.stats.categoryStats[id];
                        correct += stat.correct;
                        total += stat.correct + stat.incorrect;
                    });
                    if (total > 0) {
                        categoryAccuracy[categoryMap[prefix]] = Math.round((correct / total) * 100);
                    }
                });

                const weaknessHTML = Object.entries(categoryAccuracy)
                    .sort((a, b) => a[1] - b[1])
                    .map(([cat, acc]) => {
                        const className = acc < 60 ? 'accuracy-low' : acc < 80 ? 'accuracy-medium' : 'accuracy-high';
                        return `
                            <div class="weakness-item">
                                <span class="weakness-topic">${cat}</span>
                                <span class="weakness-accuracy ${className}">${acc}%</span>
                            </div>
                        `;
                    }).join('');

                document.getElementById('weaknessAnalysis').innerHTML = weaknessHTML || '<p>Keep solving to see your weak areas!</p>';

                // Achievements
                const achievementsHTML = ACHIEVEMENTS.map(ach => {
                    const unlocked = this.stats.achievements.includes(ach.id);
                    return `
                        <div class="achievement ${unlocked ? 'unlocked' : ''}" title="${ach.name}">
                            <div class="achievement-icon">${ach.icon}</div>
                            <div class="achievement-name">${ach.name}</div>
                        </div>
                    `;
                }).join('');

                document.getElementById('achievementsContainer').innerHTML = achievementsHTML;

                document.getElementById('statsModal').classList.add('active');
            }

            showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3500);
            }
        }

        // Initialize
        const app = new SATApp();
    </script>
</body>
</html>
